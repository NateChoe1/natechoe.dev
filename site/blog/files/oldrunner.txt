//Again, this is old code released under the GNU General Public License v3.

void *runServer(RunnerArgs *args) {
        Sitefile *site = args->site;
        //the website layout is stored within a Sitefile
        int *pending = args->pending;
        int *schedule = args->schedule;
        int id = args->id;

        Connection *connections = NULL;
        Connection *last = NULL;
        //Connections are processed in a queue, which is really just a linked
        //list where we add to the end and read from the beginning.
        for (;;) {
                if (schedule[0] == id) {
                        //If a connection is available to accepet
                        Connection *newconn = newConnection(schedule[1]);
                        assert(newconn != NULL);
                        //get that connection

                        if (last == NULL)
                                connections = newconn;
                        else
                                last->next = newconn;
                        last = newconn;
                        //add it to the queue
                        pending[id]++;
                        schedule[0] = -1;
                        //and increase the pending connections
                }

                Connection *prev = NULL;
                Connection *iter = connections;
                while (iter != NULL) {
                        //go through all the connections
                        if (updateConnection(iter, site)) {
                        //updateConnection() will get all new data from that
                        //connection and process it. It returns 1 (true) if the
                        //connection should be killed
                                if (iter == last)
                                        last = prev;
                                Connection *old = iter;
                                iter = iter->next;
                                freeConnection(old);
                                if (prev == NULL)
                                        connections = iter;
                                else
                                        prev->next = iter;
                                pending[id]--;
                                //if that connection should be killed, kill it.
                        }
                        else {
                                prev = iter;
                                iter = iter->next;
                        }
                }
        }
        return NULL;
}
